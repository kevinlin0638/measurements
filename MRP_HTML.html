<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRP Material Requirements Planning System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #e9ecef;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .result-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .component-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .product-search-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .search-form .form-group {
            margin-bottom: 0;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .table-container th,
        .table-container td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: center;
            font-size: 14px;
        }
        
        .table-container th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .table-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .table-container tr:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MRP Material Requirements Planning System</h1>
            <p>Material Requirements Planning System</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('input')">Input Data</button>
            <button class="tab" onclick="showTab('results')">Simulation Results</button>
        </div>

        <!-- Input Data Page -->
        <div id="input" class="tab-content active">
            <div class="input-section">
                <h2>Product Settings</h2>
                <div class="input-grid">
                    <div class="form-group">
                        <label>Product Name (PART NUMBER)</label>
                        <input type="text" id="productName" placeholder="e.g.: Car Model A">
                    </div>
                    <div class="form-group">
                        <label>Current Inventory</label>
                        <input type="number" id="initialInventory" value="1" min="0">
                    </div>
                </div>

                <h2>BOM Structure</h2>
                <div id="bomContainer">
                </div>
                <button class="btn" onclick="addComponent()">Add Component</button>

                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="submitCurrentPeriodData()">Submit Results</button>
                    <button class="btn btn-secondary" onclick="resetForm()">Reset Form</button>
                </div>
                
                <!-- Message Display Area -->
                <div id="message"></div>
            </div>
        </div>

        <!-- Simulation Results Page -->
        <div id="results" class="tab-content">
            <div class="product-search-section">
                <h2>Search Product Results</h2>
                <div class="search-form">
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="searchProductName" placeholder="Enter product name to search">
                    </div>
                    <button class="btn" onclick="searchProductResults()">Search Results</button>
                </div>
            </div>

            <div class="result-section">
                <h2>MRP Simulation Results Table</h2>
                <div id="mrpTableContainer">
                    <div class="alert alert-success">
                        Please enter a product name and click Search Results to view the table
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <p>Processing, please wait...</p>
    </div>

    <script>
        let mrpData = {
            productName: '',
            initialInventory: 1,
            components: [],
            simulationResults: null
        };

        // Google Apps Script API call function
        async function callGoogleAppsScript(action, data) {
            return new Promise((resolve, reject) => {
                try {
                    showLoading(true);
                    
                    // Use google.script.run to directly call functions
                    google.script.run
                        .withSuccessHandler(function(result) {
                            showLoading(false);
                            resolve(result);
                        })
                        .withFailureHandler(function(error) {
                            showLoading(false);
                            console.error('API error:', error);
                            resolve({ success: false, message: error.message });
                        })
                        [action](data);
                } catch (error) {
                    showLoading(false);
                    console.error('API call error:', error);
                    resolve({ success: false, message: error.message });
                }
            });
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        function showTab(tabName) {
            // Hide all pages
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected page
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function addComponent() {
            const container = document.getElementById('bomContainer');
            const componentDiv = document.createElement('div');
            componentDiv.className = 'component-item';
            componentDiv.innerHTML = `
                <div class="input-grid">
                    <div class="form-group">
                        <label>Component Name</label>
                        <input type="text" class="component-name" value="Component">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="component-quantity" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" class="component-supplier" value="Supplier">
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="removeComponent(this)">Remove Component</button>
            `;
            container.appendChild(componentDiv);
        }

        function removeComponent(button) {
            button.parentElement.remove();
        }

        function resetForm() {
            document.getElementById('productName').value = '';
            document.getElementById('initialInventory').value = 1;
            
            // Reset BOM
            const container = document.getElementById('bomContainer');
            container.innerHTML = `
            `;
        }

        function collectInputData() {
            mrpData.productName = document.getElementById('productName').value;
            mrpData.initialInventory = parseInt(document.getElementById('initialInventory').value);
            
            console.log('Raw form values:', {
                productName: document.getElementById('productName').value,
                initialInventory: document.getElementById('initialInventory').value
            });
            
            // Collect BOM data
            mrpData.components = [];
            const componentItems = document.querySelectorAll('.component-item');
            console.log('Found component items:', componentItems.length);
            
            componentItems.forEach((item, index) => {
                const name = item.querySelector('.component-name').value;
                const quantity = parseInt(item.querySelector('.component-quantity').value);
                const supplier = item.querySelector('.component-supplier').value;
                
                console.log(`Component ${index + 1}:`, { name, quantity, supplier });
                
                if (name && quantity > 0) {
                    mrpData.components.push({
                        name: name,
                        quantity: quantity,
                        supplier: supplier
                    });
                }
            });
            
            console.log('Final mrpData:', mrpData);
            return mrpData; // Return collected data
        }

        function submitCurrentPeriodData() {
            // Collect input data
            const mrpData = collectInputData();
            
            console.log('Frontend collected data:', mrpData);
            
            // Basic validation
            if (!mrpData.productName || mrpData.productName.trim() === '') {
                alert('Please enter product name');
                return;
            }
            
            if (!mrpData.initialInventory || mrpData.initialInventory <= 0) {
                alert('Please enter valid initial inventory');
                return;
            }
            

            
            // Remove component quantity limit, allow products without components
            
            // Validate component data
            for (let i = 0; i < mrpData.components.length; i++) {
                const component = mrpData.components[i];
                if (!component.name || component.name.trim() === '') {
                    alert('Please enter component name');
                    return;
                }
                if (!component.quantity || component.quantity <= 0) {
                    alert('Please enter valid component quantity');
                    return;
                }
                if (!component.supplier || component.supplier.trim() === '') {
                    alert('Please enter supplier name');
                    return;
                }
            }
            
            // Show loading message
            document.getElementById('message').innerHTML = '<div class="alert alert-info">Submitting data...</div>';
            
            console.log('Sending data to backend:', mrpData);
            
            // Send all data to backend
            callGoogleAppsScript('submitCurrentPeriodData', mrpData)
                .then(response => {
                    console.log('Backend response:', response);
                    if (response.success) {
                        document.getElementById('message').innerHTML = '<div class="alert alert-success">' + response.message + '</div>';
                        // Don't reset form after successful submission
                    } else {
                        document.getElementById('message').innerHTML = '<div class="alert alert-danger">' + response.message + '</div>';
                    }
                })
                .catch(error => {
                    console.error('Frontend error:', error);
                    document.getElementById('message').innerHTML = '<div class="alert alert-danger">Error occurred while submitting data: ' + error.message + '</div>';
                });
        }

        async function searchProductResults() {
            const productName = document.getElementById('searchProductName').value;
            
            if (!productName) {
                alert('Please enter product name');
                return;
            }

            try {
                const result = await callGoogleAppsScript('getProductResults', {
                    productName: productName
                });
                
                if (result.success) {
                    displayProductResults(result.data);
                } else {
                    document.getElementById('mrpTableContainer').innerHTML = 
                        '<div class="alert alert-error">Search failed: ' + result.message + '</div>';
                }
            } catch (error) {
                console.error('Error searching product results:', error);
                document.getElementById('mrpTableContainer').innerHTML = 
                    '<div class="alert alert-error">Error occurred while searching: ' + error.message + '</div>';
            }
        }

        function displayProductResults(data) {
            const container = document.getElementById('mrpTableContainer');
            
            if (!data || !data.finishedGoodsMRP || !data.componentInventory) {
                container.innerHTML = '<div class="alert alert-error">No data found for this product</div>';
                return;
            }

            let html = `
                <h3>Table 1: Finished Goods MRP</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time Period</th>
                                <th>Demand for Finished Goods</th>
                                <th>On-Hand Inventory</th>
                                <th>Inventory Gap</th>
                                <th>Production Start</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Determine number of periods to display based on data
            // Currently only showing period 1, as data only has period 1
            const periodsToShow = 1; // Only show period 1
            
            // Display finished goods MRP table
            for (let i = 0; i < periodsToShow; i++) {
                const period = i + 1;
                const demand = data.finishedGoodsMRP.demand[i] || 0;
                const inventory = data.finishedGoodsMRP.inventory[i] || 0;
                const gap = data.finishedGoodsMRP.gap[i];
                const productionStart = data.finishedGoodsMRP.productionStart[i] || 0;
                
                html += `
                    <tr>
                        <td>${period}</td>
                        <td>${demand}</td>
                        <td>${inventory}</td>
                        <td>${gap !== null ? gap : 'Null'}</td>
                        <td>${productionStart}</td>
                    </tr>
                `;
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            resetForm();
        });
    </script>
</body>
</html> 